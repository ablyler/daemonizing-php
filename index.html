<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>Daemonizing PHP - OSCON 2013</title>

		<meta name="description" content="Creating daemons using PHP">
		<meta name="author" content="Andy Blyler">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<link rel="stylesheet" href="css/reveal.min.css">
		<link rel="stylesheet" href="css/theme/sky.css" id="theme">

		<style>
			section td, th {
				border: 1px solid black !important;
				width: 50%;
				padding: 10px !important;
				vertical-align: top !important;
			}
			section th {
				text-align: center !important;
			}
			section table {
			    table-layout: fixed;
			    width: 100%;
				border-collapse: collapse !important;
				padding: 5px;
			}
		</style>

		<!-- For syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- If the query includes 'print-pdf', use the PDF print sheet -->
		<script>
			document.write( '<link rel="stylesheet" href="css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>

	<body>
		<div class="reveal">

			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

				<section>
					<h1>Daemonizing PHP</h1>
					<h3>Usining PHP to run your backend processes</h3>
					<p>
						<small>By <a href="http://andyblyler.com">Andy Blyler</a> (<a href="http://twitter.com/ablyler">@ablyler</a>) and <a href="">Jon Kuperman</a> (<a href="http://twitter.com/insitedesignlab">@insitedesignlab</a>) </small>
					</p>
				</section>

				<section>
					<h2>WHOIS Andy Blyler</h2>

					<p>
						Lead Software Engineer @ <a href="https://www.barracuda.com/">Barracuda Networks</a><br />
						working on the <a href="https://www.barracuda.com/backup">Backup</a> product since 2006.
					</p>

					<aside class="notes">
						Andy
					</aside>
				</section>
				<section>
					<h2>WHOIS Jon Kuperman</h2>

					<p>
						Software Engineer @ <a href="https://www.barracuda.com/">Barracuda Networks</a><br />
						web developer and new employee at Barracuda <a href="https://www.barracuda.com/backup">Backup</a>
					</p>

					<aside class="notes">
						Jon
					</aside>
				</section>

				<section>
					<h2>Presentation Agenda</h2>
					<p>What is a Daemon / Forking</p>
					<p>Why PHP Daemons</p>
					<p>Using our library</p>
					<p>Real World Results</p>

					<aside class="notes">
						Jon
					</aside>
				</section>

				<!-- What is a Daemon? -->
				<section>
					<section>
						<h2>What is a Daemon</h2>
						<h4 style="text-align: left;">dae·mon</h4>
						<p style="text-align: left;"><i>/ˈdēmən/</i></p>
						<p style="text-align: left;"><b>Noun</b><br />
						<ol style="padding-left: 15px;">
							<li style="padding-bottom: 10px;">(in ancient Greek belief) A divinity or supernatural being of a nature between gods and humans.</li>
							<li>A background process that handles requests for services such as print spooling and is dormant when not required.</li>
						</ol>
						</p>

						<aside class="notes">
							Jon
						</aside>
					</section>

					<section>
						<h2>What is Forking</h2>
						<h4 style="text-align: left;">forking</h4>
						<p style="text-align: left;"><i>/fɔrkɪn/</i></p>
						<p style="text-align: left;"><b>Verb</b><br />
						<ol style="padding-left: 15px;">
							<li style="padding-bottom: 10px;">(esp. of a road or other route) Divide into two parts: "the place where the road forks".</li>
							<li>Dig, lift, or manipulate (something) with a fork: "fork in some compost".</li>
						</ol>
						</p>

						<aside class="notes">
							Jon
						</aside>
					</section>

					<section>
						<video width="100%" height="100%" muted>
							<source src="./videos/forking.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>

					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/forking.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
				</section>

				<!-- Why PHP Daemons? -->
				<section>
					<section>
						<h2>Why PHP Daemons?</h2>
						<aside class="notes">
							Andy

							To better understand why we use PHP, let's take a step back and look at the backup product.
						</aside>
					</section>
					<section>
						<h2>High Level Backup Architecture</h2>

						<img src="images/bbs-1k-foot-architecture.png" style="border: 0px; box-shadow: none;" />
						<aside class="notes">
							Andy

							Source Servers: Windows / Linux
							- run our C++ based agent
							Backup Appliance & Cloud are Linux machines that we manage
						</aside>
					</section>
					<section>
						<h2>Why PHP?</h2>
						<p>
							<ul>
								<li>Fast and easy development</li>
								<li>Works well for both web sites and backends</li>
								<li>Popularity (makes it easier to find developers)</li>
								<li>The founding developers knew it</li>
								<li>Ability to share code between Appliance and Cloud</li>
							</ul>
						</p>

						<aside class="notes">
							Jon
						</aside>
					</section>
					<section>
						<h2>Our Components</h2>

						<table>
							<tr>
								<th><h3><img src="./images/appliance.png" style="position: relative; top: 13px; border: 0px; box-shadow: none;"/></h3></th>
								<th><h3><img src="./images/cloud.png" style="border: 0px; box-shadow: none;"/></h3></th>
							</tr>
							<tr>
								<td>
									<ul>
										<li>Backup</li>
										<li>Restore</li>
										<li><b>Replication</b></li>
										<li><b>Retention</b></li>
										<li>Stats</li>
										<li><b>Storage</b></li>
										<li><b>Web UI</b></li>
									</ul>
								</td>
								<td>
									<ul>
										<li><b>Replication</b></li>
										<li><b>Retention</b></li>
										<li><b>Storage</b></li>
										<li><b>Web UI</b></li>
									</ul>
								</td>
							</tr>
						</table>

						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<h2>Shared Code</h2>

						<p>
							<ul>
								<li>Database</li>
								<li>Forking</li>
								<li>Network Protocol</li>
								<li>Graphing</li>
								<li>Process Management</li>
								<li>FUSE Layer</li>
								<li>File System</li>
							</ul>
						</p>

						<aside class="notes">
							Jon
						</aside>
					</section>
				</section>
				<section>
					<section>
						<h2>Our Forking Library</h2>
						<a href="http://git.io/forkdaemon-php" style="margin-bottom: 50px;">http://git.io/forkdaemon-php</a>

						<p>Actively maintained for 5+ years.</p>
						<p>Open source just days ago!</p>

						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<h2>A Basic Example</h2>
<pre><code>/* setup forking daemon */
$server = new fork_daemon();
$server->max_work_per_child_set(3);
$server->register_child_run("process_child_run");

/* add work units */
$data_set = array(1, 2, 3, 4, 5, 6, 7, 8, 9, 10);
$server->addwork($data_set);

/* process work blocking mode */
$server->process_work(true);

/* registered call back function */
function process_child_run($data_set)
{
  echo "I'm child working on: " . implode(",", $data_set) . PHP_EOL;
}</pre></code>
						<aside class="notes">
							Jon
						</aside>
					</section>
					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/examples/1-basic.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
					<section>
						<h2>Buckets</h2>
<pre><code>define("BUCKET1", 1);
define("BUCKET2", 2);

$server->add_bucket(BUCKET1);
$server->add_bucket(BUCKET2);
$server->max_children_set(2, BUCKET1);
$server->max_children_set(5, BUCKET2);
$server->register_child_run("process_child_run_1", BUCKET1);
$server->register_child_run("process_child_run_2", BUCKET2);

$data_set = array();
for($i=0; $i<100; $i++) $data_set[] = $i;

$server->addwork($data_set, "", BUCKET1);
$server->addwork($data_set, "", BUCKET2);
</code></pre>
						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/examples/2-buckets.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
					<section>
						<h2>Resource Management</h2>
<pre><code>/* setup forking daemon */
$server = new fork_daemon();
$server->register_parent_prefork(array('prefork'));
...

function prefork()
{
  echo "I'm closing resources..." . PHP_EOL;
}</code></pre>

						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/examples/3-prefork-callbacks.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
					<section>
						<h2>Logging</h2>
<pre><code>$log = new Logger('forker');

/* setup forking daemon */
$s = new fork_daemon();
$s->register_logging(array($log, 'addCritical'), fork_daemon::LOG_LEVEL_CRIT);
$s->register_logging(array($log, 'addWarning'),  fork_daemon::LOG_LEVEL_WARN);
$s->register_logging(array($log, 'addInfo'),     fork_daemon::LOG_LEVEL_INFO);
$s->register_logging(array($log, 'addDebug'),    fork_daemon::LOG_LEVEL_DEBUG);</code></pre>

						<aside class="notes">
							Jon
						</aside>
					</section>
					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/examples/4-logging.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
					<section>
						<h2>Helpers</h2>
<pre><code>/* setup forking daemon */
$server = new fork_daemon();
$server->helper_process_spawn('helper');
...
function helper()
{
	echo "starting helper" . PHP_EOL;

	for ($i = 0; $i < 3; $i++)
	{
		echo "helper: " . $i . PHP_EOL;
		sleep(1);
	}

	exit();
}</code></pre>

						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<video width="100%" height="100%" data-autoplay muted>
							<source src="./videos/examples/5-helper.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>
					</section>
				</section>

				<!-- Real World Results -->
				<section>
					<section>
						<h2>Storage Daemon</h2>
						<video width="100%" height="100%" data-autoplay loop muted>
							<source src="./videos/cloud.mov" type="video/mp4">
							Your browser does not support the video tag.
						</video>

						<aside class="notes">
							Jon
						</aside>
					</section>
					<section>
						<h2>Our Daemons at work</h2>
						<img src="./images/screenshot.png" />

						<aside class="notes">
							Andy
						</aside>
					</section>
					<section>
						<h2>Statistics</h2>
						<p class="fragment fade-in">A backup is started <strong>every two seconds</strong></p>
						<p class="fragment fade-in">Cloud processes a <strong>petabyte</strong> every <strong>1.5 days</strong></p>

						<aside class="notes">
							Jon
						</aside>
					</section>
				</section>
			</div>

		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.min.js"></script>

		<script>

			// Full list of configuration options available here:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: true,
				progress: true,
				history: true,
				center: true,
				margin: 0.2,

				theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
				transition: Reveal.getQueryHash().transition || 'default', // default/cube/page/concave/zoom/linear/fade/none

				// multiplex: {
				//secret: '13682960645763249742', // null so the clients do not have control of the master presentation
				//id: '495d7295935060d6', // id, obtained from socket.io server
				//url: 'localhost:1948' // Location of your socket.io server
				// },

				// Optional libraries used to extend on reveal.js
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
					{ src: 'plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/search/search.js', async: true, condition: function() { return !!document.body.classList; } }
					// { src: 'plugin/remotes/remotes.js', async: true, condition: function() { return !!document.body.classList; } }
				]
			});

		</script>

		<div class="slideshow-footer" style="display: none; position: absolute; bottom: 10px; left: 50%; margin-left: -125px; z-index: 20;">
			<a href="https://www.barracuda.com"><img src="images/barracuda.png" width="250" /></a>
		</div>

		<script>
			if( !navigator.userAgent.match( /iphone|ipod|android|ipad|blackberry/gi ) && !!document.querySelector ) {
				document.querySelector( '.slideshow-footer' ).style.display = 'block';
			}
		</script>

	</body>
</html>
